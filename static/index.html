<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-   scale=1.0">
		<title>NOLOOKING Lightning PayJoin</title>
		<style>
			.invisible {
				display: none;
			}
		</style>
	</head>
	<body>
		<header>
			<h1><u>L</u>ightning PayJ<u>oin</u></h1>
			<h2>Queue a batch of lightning channels to open with one <a href="https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki" target="blank">BIP 78</a> <a href="https://bitcoinmagazine.com/culture/blockchain-analysis-about-get-harder-p2ep-enters-testing-phase" target="blank">P2EP</a> PayJoin</h2>
		</header>
		<main>
			<p style="color: orange">Halloween-quality pre-alpha software. A lil spooky!</p>
			<form action="/pj/schedule" method="post" enctype="application/x-www-form-urlencoded">
				<div>
					<label for="reserve" >
					<details>
						<summary>
							Anchor Reserve Deposit (sats)</label>
						</summary>
						New nodes need a reserve output of at least 10,000 sats. Set this to 10,000 fo a new node. 0 is fine thereafter.
					</details>
					<input type="number" name="wallet_amount" id="wallet" list="defaultReserveSats" min="0" step="1">
					<datalist id="defaultReserveSats">
						<option value="10000"></option>
					</datalist>
				</label>
			</div>
			<div>
				<label>
					Maximum fee rate (sats/vB)
					<input type="text" name="fee_rate" id="feerate" value="1">
				</label>
			</div>
				<fieldset>
					<legend>Channels to Open</legend>
					<!-- channels -->
					<table id="channels">
						<tr><th>Destination Node</th><th>Desired Channel Capacity (sats)</th></tr>
						<tr><td><input type="text" name="channels[0][node]"></td><td><input type="number" name="channels[0][amount]" min="20000" step="1"></td></tr><!-- LND enforces minimum 20k sats channel -->
					</table>
					<button type="button" onclick="add_channel()">Add channel</button>
				</fieldset>

				<div id="queue">
				<button type="submit">Generate payment request URI</button>
				</div>
			</form>
			<output id="queued" class="invisible">
				<h2>PayJoin here to open these channels</h2>
				<a href="" id="bip21"></a>
			</output>
		</main>
		<script type="text/javascript">
			function add_channel() {
				var table = document.getElementById("channels");
				table.innerHTML = table.innerHTML + "<tr><td><input type=\"text\"></td><td><input type=\"text\"></td></tr>";
			}

			document.querySelector("form").addEventListener("submit", async (event) => {
				event.preventDefault();
				let form = event.currentTarget;
				let resource = form.action;
				let options = {
					method: form.method,
					headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
					// encode FormData as x-www-form-urlencoded
					body: new URLSearchParams(new FormData(form)).toString()
				};

				await fetch(resource, options)
					.then(async (r) => {
						if (!r.ok)
							throw new Error('Something went wrong.');

						let link = document.getElementById("bip21");
						let bip21 = await r.text();
						link.href = bip21;
						link.innerHTML = bip21;
						document.getElementById("queue").classList.add("invisible");
						document.getElementById("queued").classList.remove("invisible");
					})
					.catch((err) => {
						alert(err);
					});
				return false; // don't trigger form action attribute, we submitted through js
			});
		</script>
	</body>
</html>
